<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPA Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&family=Farsan&family=Poppins:wght@500;800&family=Tomorrow:wght@400;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .dropzone-active {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .swatch {
            transition: transform 0.1s ease-in-out;
        }
        .swatch:hover {
            transform: scale(1.1);
        }
        .form-radio {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid currentColor;
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
        }
        .form-radio::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb;
        }
        .form-radio:checked::before {
            transform: scale(1);
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.25rem; }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Image Generator</h1>
            <p class="text-slate-500 mt-2">Design your background, select players or a logo, and generate a high-res image.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            <div class="flex flex-col gap-8">
                <!-- Step 1: Logo Upload -->
                <div id="logo-upload-wrapper" class="flex flex-col">
                    <label class="font-semibold text-slate-700 mb-2">Step 1: Upload Your Logo</label>
                    <div id="dropzone" class="relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors">
                        <div id="dropzone-prompt" class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                            <svg class="w-8 h-8 mb-4 text-slate-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-2 text-sm text-slate-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-slate-500">PNG, JPG, SVG, or WEBP</p>
                        </div>
                        <img id="logo-preview" src="" class="hidden absolute h-full w-full object-contain p-4" alt="Logo Preview"/>
                        <input id="file-upload" type="file" class="hidden" accept="image/png, image/jpeg, image/svg+xml, image/webp" />
                    </div>
                    <div id="file-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>

                <!-- Step 3: Custom Text -->
                <div>
                    <label for="custom-text-input" class="font-semibold text-slate-700 mb-2 block">Step 3: Add Text (Optional)</label>
                    <input type="text" id="custom-text-input" placeholder="Enter text to display" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
            </div>

            <div class="flex flex-col">
                <!-- Step 2: Background Design -->
                <label class="font-semibold text-slate-700 mb-2">Step 2: Design Background</label>
                <div class="mb-4">
                    <label class="text-sm text-slate-600 mb-2 block font-medium">Background Type:</label>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="bg-type" value="solid" checked class="form-radio text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-slate-700">Solid Color</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="bg-type" value="diagonal" class="form-radio text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-slate-700">Diagonal Split</span>
                        </label>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="add-blur" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-slate-700">Add Blur</span>
                    </label>
                </div>

                <div id="blur-slider-wrapper" class="mt-4 hidden">
                    <label for="blur-intensity" class="text-sm text-slate-600 font-medium mb-2 block">Blur Intensity:</label>
                    <input type="range" id="blur-intensity" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div id="color-controls-wrapper" class="transition-opacity duration-300">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="color-1-wrapper">
                            <label for="hex-input-1" class="text-sm text-slate-600 font-medium mb-2 block">Color 1:</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-picker-1" value="#000000" class="p-0 h-10 w-12 block bg-white border border-slate-300 rounded-md cursor-pointer">
                                <input type="text" id="hex-input-1" value="#000000" maxlength="7" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                        <div id="color-2-wrapper" class="hidden">
                            <label for="hex-input-2" class="text-sm text-slate-600 font-medium mb-2 block">Color 2:</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-picker-2" value="#FFFFFF" class="p-0 h-10 w-12 block bg-white border border-slate-300 rounded-md cursor-pointer">
                                <input type="text" id="hex-input-2" value="#FFFFFF" maxlength="7" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4" id="presets-1-wrapper">
                        <p class="text-sm text-slate-600 mb-2">Presets (sets Color 1):</p>
                        <div class="flex flex-wrap gap-2">
                            <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #4d7d4b" data-color="#4d7d4b"></div>
                            <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #616161" data-color="#616161"></div>
                            <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #d37d16" data-color="#d37d16"></div>
                            <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #678794" data-color="#678794"></div>
                            <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #FACC15" data-color="#FACC15"></div>
                        </div>
                    </div>
                    <div class="mt-4 hidden" id="presets-2-wrapper">
                        <p class="text-sm text-slate-600 mb-2">Presets (sets Color 2):</p>
                        <div class="flex flex-wrap gap-2">
                           <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #4d7d4b" data-color="#4d7d4b"></div>
                           <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #616161" data-color="#616161"></div>
                           <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #d37d16" data-color="#d37d16"></div>
                           <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #678794" data-color="#678794"></div>
                           <div class="swatch w-8 h-8 rounded-full cursor-pointer border border-slate-200" style="background-color: #FACC15" data-color="#FACC15"></div>
                        </div>
                    </div>
                </div>
                 <!-- Player Selection - now part of background controls -->
                <div id="player-select-wrapper" class="hidden mt-4">
                    <div class="flex items-center justify-between">
                         <label class="font-semibold text-slate-700 mb-2 block border-t pt-4 mt-4">Optional: Add Player Images</label>
                         <div class="flex items-center pt-4 mt-4">
                            <input type="checkbox" id="doubles-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="doubles-checkbox" class="ml-2 text-sm text-slate-700 font-medium">Doubles</label>
                        </div>
                    </div>
                   
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="player1-search" class="text-sm font-medium text-slate-600 mb-1 block">Player 1</label>
                            <input type="text" id="player1-search" placeholder="Search Player 1..." class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm mb-2">
                            <select id="player1-select" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="">Loading players...</option>
                            </select>
                        </div>
                        <div>
                            <label for="player2-search" class="text-sm font-medium text-slate-600 mb-1 block">Player 2</label>
                             <input type="text" id="player2-search" placeholder="Search Player 2..." class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm mb-2">
                            <select id="player2-select" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="">Loading players...</option>
                            </select>
                        </div>
                    </div>
                     <div id="doubles-players-wrapper" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 hidden">
                        <div>
                            <label for="player3-search" class="text-sm font-medium text-slate-600 mb-1 block">Player 3</label>
                            <input type="text" id="player3-search" placeholder="Search Player 3..." class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm mb-2">
                            <select id="player3-select" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="">Select Player 3</option>
                            </select>
                        </div>
                        <div>
                            <label for="player4-search" class="text-sm font-medium text-slate-600 mb-1 block">Player 4</label>
                             <input type="text" id="player4-search" placeholder="Search Player 4..." class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm mb-2">
                            <select id="player4-select" class="w-full px-3 py-2 text-slate-700 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="">Select Player 4</option>
                            </select>
                        </div>
                    </div>
                    <div id="player-loading-error" class="text-red-500 text-sm mt-1 hidden">Could not load player data.</div>
                     <div id="player-images-preview" class="grid grid-cols-2 gap-4 mt-2">
                        <img id="player1-preview" src="https://placehold.co/300x200/e2e8f0/e2e8f0?text=." class="w-full h-auto object-cover rounded-md bg-slate-100 aspect-[3/2]" alt="Player 1 Preview"/>
                        <img id="player2-preview" src="https://placehold.co/300x200/e2e8f0/e2e8f0?text=." class="w-full h-auto object-cover rounded-md bg-slate-100 aspect-[3/2]" alt="Player 2 Preview"/>
                    </div>
                    <div id="doubles-preview-wrapper" class="grid grid-cols-2 gap-4 mt-2 hidden">
                        <img id="player3-preview" src="https://placehold.co/300x200/e2e8f0/e2e8f0?text=." class="w-full h-auto object-cover rounded-md bg-slate-100 aspect-[3/2]" alt="Player 3 Preview"/>
                        <img id="player4-preview" src="https://placehold.co/300x200/e2e8f0/e2e8f0?text=." class="w-full h-auto object-cover rounded-md bg-slate-100 aspect-[3/2]" alt="Player 4 Preview"/>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
             <button id="generate-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed disabled:scale-100">
                 Generate Image
             </button>
        </div>

        <div id="output-section" class="mt-10 hidden">
            <div class="flex justify-between items-center mb-4 border-t pt-6">
                <h2 class="text-2xl font-bold text-slate-800">Your Image</h2>
            </div>
            <div id="image-grid" class="grid grid-cols-1 gap-6">
            </div>
            <div id="loading-spinner" class="text-center p-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-slate-600">Generating your image...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION: UPDATE THESE VALUES ---
            const ATHLETE_CONTAINER_SELECTOR = 'div.featured-players__athlete';
            const ATHLETE_NAME_SELECTOR = 'div.featured-players__athlete-name';
            const ATHLETE_IMAGE_SELECTOR = 'img.featured-players__athlete-img';
            const CORS_PROXY_URL = 'https://corsproxy.io/?';
            const PPA_ATHLETES_URL = `${CORS_PROXY_URL}${'https://www.ppatour.com/athletes/'}`;
            // --- END CONFIGURATION ---


            // --- DOM Element Selectors ---
            const generateBtn = document.getElementById('generate-btn');
            const bgTypeRadios = document.querySelectorAll('input[name="bg-type"]');
            const logoUploadWrapper = document.getElementById('logo-upload-wrapper');
            const dropzone = document.getElementById('dropzone');
            const fileUpload = document.getElementById('file-upload');
            const logoPreview = document.getElementById('logo-preview');
            const dropzonePrompt = document.getElementById('dropzone-prompt');
            const fileError = document.getElementById('file-error');
            const playerSelectWrapper = document.getElementById('player-select-wrapper');
            const doublesCheckbox = document.getElementById('doubles-checkbox');
            const doublesPlayersWrapper = document.getElementById('doubles-players-wrapper');
            const doublesPreviewWrapper = document.getElementById('doubles-preview-wrapper');
            const player1Select = document.getElementById('player1-select');
            const player2Select = document.getElementById('player2-select');
            const player3Select = document.getElementById('player3-select');
            const player4Select = document.getElementById('player4-select');
            const player1Search = document.getElementById('player1-search');
            const player2Search = document.getElementById('player2-search');
            const player3Search = document.getElementById('player3-search');
            const player4Search = document.getElementById('player4-search');
            const player1Preview = document.getElementById('player1-preview');
            const player2Preview = document.getElementById('player2-preview');
            const player3Preview = document.getElementById('player3-preview');
            const player4Preview = document.getElementById('player4-preview');
            const playerLoadingError = document.getElementById('player-loading-error');
            const customTextInput = document.getElementById('custom-text-input');
            const outputSection = document.getElementById('output-section');
            const imageGrid = document.getElementById('image-grid');
            const loadingSpinner = document.getElementById('loading-spinner');
            const color2Wrapper = document.getElementById('color-2-wrapper');
            const colorPicker1 = document.getElementById('color-picker-1');
            const hexInput1 = document.getElementById('hex-input-1');
            const colorPicker2 = document.getElementById('color-picker-2');
            const hexInput2 = document.getElementById('hex-input-2');
            const presets1Wrapper = document.getElementById('presets-1-wrapper');
            const presets2Wrapper = document.getElementById('presets-2-wrapper');
            const swatches1 = presets1Wrapper.querySelectorAll('.swatch');
            const swatches2 = presets2Wrapper.querySelectorAll('.swatch');
            const addBlurCheckbox = document.getElementById('add-blur');
            const blurSliderWrapper = document.getElementById('blur-slider-wrapper');
            const blurIntensity = document.getElementById('blur-intensity');
            
            // --- State & Constants ---
            let uploadedLogo = null;
            let playersData = [];
            const SIZES = [{ width: 3840, height: 2160 }];

            // --- Player Data Fetching ---
            async function fetchPlayers() {
                try {
                    const response = await fetch(PPA_ATHLETES_URL);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const htmlText = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    
                    const players = [];
                    const athleteCards = doc.querySelectorAll(ATHLETE_CONTAINER_SELECTOR);

                    athleteCards.forEach(card => {
                        const nameEl = card.querySelector(ATHLETE_NAME_SELECTOR);
                        const imgEl = card.querySelector(ATHLETE_IMAGE_SELECTOR);
                        const imgSrc = imgEl ? (imgEl.dataset.lazySrc || imgEl.src) : null;
                        
                        if (nameEl && imgSrc) {
                            players.push({ name: nameEl.innerText.trim(), imageUrl: imgSrc });
                        }
                    });

                    if (players.length === 0) {
                       throw new Error('No players found. Check selectors.');
                    }
                    
                    players.sort((a, b) => a.name.localeCompare(b.name));
                    playersData = players;
                    populateDropdowns();

                } catch (error) {
                    console.error("Failed to fetch player data:", error);
                    playerLoadingError.classList.remove('hidden');
                    [player1Select, player2Select, player3Select, player4Select].forEach(sel => {
                        sel.innerHTML = '<option value="">Error loading data</option>';
                    });
                }
            }

            function populateDropdowns() {
                [player1Select, player2Select, player3Select, player4Select].forEach((sel, index) => {
                    sel.innerHTML = `<option value="">Select Player ${index + 1}</option>`;
                    playersData.forEach(player => {
                        sel.add(new Option(player.name, player.imageUrl));
                    });
                });
            }

            // --- UI Controls Logic ---
            function updateBackgroundControls() {
                const selectedBgType = document.querySelector('input[name="bg-type"]:checked').value;
                const isDiagonal = selectedBgType === 'diagonal';
                
                color2Wrapper.classList.toggle('hidden', !isDiagonal);
                presets2Wrapper.classList.toggle('hidden', !isDiagonal);
                playerSelectWrapper.classList.toggle('hidden', !isDiagonal);

                if (isDiagonal && playersData.length === 0) {
                    fetchPlayers();
                }
                updateGenerateButtonState();
            }

            // --- File Upload Logic ---
            dropzone.addEventListener('click', () => fileUpload.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.add('dropzone-active')));
            ['dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.remove('dropzone-active')));
            dropzone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
            fileUpload.addEventListener('change', e => handleFile(e.target.files[0]));

            function handleFile(file) {
                fileError.classList.add('hidden');
                uploadedLogo = null; 
                if (!file || !file.type.startsWith('image/')) {
                    fileError.textContent = 'Please select a valid image file.';
                    fileError.classList.remove('hidden');
                } else {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            uploadedLogo = img;
                            logoPreview.src = e.target.result;
                            logoPreview.classList.remove('hidden');
                            dropzonePrompt.classList.add('hidden');
                            updateGenerateButtonState();
                        };
                        img.onerror = () => {
                             fileError.textContent = 'Could not load the image file.';
                             fileError.classList.remove('hidden');
                             updateGenerateButtonState();
                        }
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
                updateGenerateButtonState();
            }
            
            // --- General Event Listeners ---
            bgTypeRadios.forEach(radio => radio.addEventListener('change', updateBackgroundControls));
            addBlurCheckbox.addEventListener('change', (e) => blurSliderWrapper.classList.toggle('hidden', !e.target.checked));
            customTextInput.addEventListener('input', (e) => {
                const start = e.target.selectionStart;
                e.target.value = e.target.value.toUpperCase();
                e.target.setSelectionRange(start, start);
            });
            doublesCheckbox.addEventListener('change', () => {
                const isChecked = doublesCheckbox.checked;
                doublesPlayersWrapper.classList.toggle('hidden', !isChecked);
                doublesPreviewWrapper.classList.toggle('hidden', !isChecked);
                if (!isChecked) {
                    player3Select.value = '';
                    player4Select.value = '';
                    player3Select.dispatchEvent(new Event('change'));
                    player4Select.dispatchEvent(new Event('change'));
                }
                updateGenerateButtonState();
            });

            player1Select.addEventListener('change', () => { player1Preview.src = player1Select.value || 'https://placehold.co/300x200/e2e8f0/e2e8f0?text=.'; updateGenerateButtonState(); });
            player2Select.addEventListener('change', () => { player2Preview.src = player2Select.value || 'https://placehold.co/300x200/e2e8f0/e2e8f0?text=.'; updateGenerateButtonState(); });
            player3Select.addEventListener('change', () => { player3Preview.src = player3Select.value || 'https://placehold.co/300x200/e2e8f0/e2e8f0?text=.'; updateGenerateButtonState(); });
            player4Select.addEventListener('change', () => { player4Preview.src = player4Select.value || 'https://placehold.co/300x200/e2e8f0/e2e8f0?text=.'; updateGenerateButtonState(); });
            
            player1Search.addEventListener('input', () => filterDropdown(player1Search, player1Select));
            player2Search.addEventListener('input', () => filterDropdown(player2Search, player2Select));
            player3Search.addEventListener('input', () => filterDropdown(player3Search, player3Select));
            player4Search.addEventListener('input', () => filterDropdown(player4Search, player4Select));

            function filterDropdown(searchInput, selectElement) {
                const filter = searchInput.value.toLowerCase();
                for (const option of selectElement.options) {
                    const txtValue = option.textContent || option.innerText;
                    option.style.display = (option.value === "" || txtValue.toLowerCase().includes(filter)) ? "" : "none";
                }
            }


            // --- Button State Logic ---
            function updateGenerateButtonState() {
                const isDiagonal = document.querySelector('input[name="bg-type"]:checked').value === 'diagonal';
                let playersSelected = player1Select.value && player2Select.value;
                if (doublesCheckbox.checked) {
                    playersSelected = playersSelected && player3Select.value && player4Select.value;
                }
                generateBtn.disabled = !(uploadedLogo || (isDiagonal && playersSelected));
            }

            // --- Image Generation Logic ---
            generateBtn.addEventListener('click', generateImages);

            async function generateImages() {
                if (generateBtn.disabled) return;

                imageGrid.innerHTML = '';
                outputSection.classList.remove('hidden');
                loadingSpinner.classList.remove('hidden');
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                
                try {
                    await document.fonts.load('300 1em Inter');
                    await document.fonts.load('800 1em Inter');
                    await document.fonts.load('bold 1em Inter');
                    await document.fonts.load('300 1em Farsan');
                    await document.fonts.load('800 1em Poppins');
                    await document.fonts.load('700 1em Chakra Petch');
                } catch (err) { console.error('Font could not be loaded: ', err); }
                
                await new Promise(resolve => setTimeout(resolve, 50));

                const bgType = document.querySelector('input[name="bg-type"]:checked').value;
                const color1 = hexInput1.value;
                const color2 = hexInput2.value;
                const customText = customTextInput.value.trim();
                const usePlayers = bgType === 'diagonal' && player1Select.value && player2Select.value;


                for (const size of SIZES) {
                    const canvas = document.createElement('canvas');
                    canvas.width = size.width;
                    canvas.height = size.height;
                    const ctx = canvas.getContext('2d');

                    if (bgType === 'solid') {
                        ctx.fillStyle = color1;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    } else {
                        const offset = canvas.width * 0.1;
                        ctx.fillStyle = color1;
                        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(canvas.width / 2 + offset, 0); ctx.lineTo(canvas.width / 2 - offset, canvas.height); ctx.lineTo(0, canvas.height); ctx.closePath(); ctx.fill();
                        ctx.fillStyle = color2;
                        ctx.beginPath(); ctx.moveTo(canvas.width / 2 + offset, 0); ctx.lineTo(canvas.width, 0); ctx.lineTo(canvas.width, canvas.height); ctx.lineTo(canvas.width / 2 - offset, canvas.height); ctx.closePath(); ctx.fill();
                    }
                    
                    if (addBlurCheckbox.checked) {
                        ctx.filter = `blur(${blurIntensity.value}px)`;
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                    }

                    if (usePlayers) {
                        const doublesMode = doublesCheckbox.checked && player3Select.value && player4Select.value;

                        if (uploadedLogo) {
                            const logoPaddingPercent = 0.35;
                            const maxLogoDim = Math.min(canvas.width, canvas.height) * logoPaddingPercent;
                            const logoAR = uploadedLogo.width / uploadedLogo.height;
                            let logoWidth, logoHeight;
                            if (logoAR > 1) { 
                                logoWidth = maxLogoDim; 
                                logoHeight = logoWidth / logoAR; 
                            } else { 
                                logoHeight = maxLogoDim; 
                                logoWidth = logoHeight * logoAR; 
                            }
                            
                            const logoX = (canvas.width - logoWidth) / 2;
                            const logoY = canvas.height * 0.125; 
                            
                            ctx.drawImage(uploadedLogo, logoX, logoY, logoWidth, logoHeight);
                        }

                        if (doublesMode) {
                            const [p1, p2, p3, p4] = await Promise.all([
                                loadImage(player1Select.value), loadImage(player2Select.value),
                                loadImage(player3Select.value), loadImage(player4Select.value)
                            ]);
                            
                            const imgHeight = canvas.height * 0.85;
                            const p1Width = imgHeight * (p1.width / p1.height);
                            const p2Width = imgHeight * (p2.width / p2.height);

                            const p3Height = imgHeight * 0.9;
                            const p3Width = p3Height * (p3.width / p3.height);

                            const p4Height = imgHeight * 0.9;
                            const p4Width = p4Height * (p4.width / p4.height);
                           
                            const imgY = canvas.height - imgHeight;
                            const p3Y = canvas.height - p3Height;
                            const p4Y = canvas.height - p4Height;

                            const separationOffset = canvas.width * 0.015;

                            const p1OrigX = 0;
                            const p2OrigX = canvas.width - p2Width;

                            const p1TargetX = p1OrigX - (canvas.width * 0.12);
                            const p3TargetX = p1OrigX;
                            const p1NewX = p1TargetX - separationOffset;
                            const p3NewX = p3TargetX + separationOffset + (canvas.width * 0.08);

                            const p2TargetX = p2OrigX + (canvas.width * 0.12);
                            const p4TargetX = p2OrigX;
                            const p2NewX = p2TargetX + separationOffset;
                            const p4NewX = p4TargetX - separationOffset - (canvas.width * 0.08);

                            ctx.drawImage(p1, p1NewX, imgY, p1Width, imgHeight);
                            ctx.drawImage(p3, p3NewX, p3Y, p3Width, p3Height);
                            
                            ctx.drawImage(p2, p2NewX, imgY, p2Width, imgHeight);
                            ctx.drawImage(p4, p4NewX, p4Y, p4Width, p4Height);
                            
                            const name1 = player1Select.options[player1Select.selectedIndex].text;
                            const name2 = player2Select.options[player2Select.selectedIndex].text;
                            const name3 = player3Select.options[player3Select.selectedIndex].text;
                            const name4 = player4Select.options[player4Select.selectedIndex].text;

                            drawDoublesNames(ctx, name1, name3, 'left');
                            drawDoublesNames(ctx, name2, name4, 'right');

                        } else {
                            const playerImg1 = await loadImage(player1Select.value);
                            const playerImg2 = await loadImage(player2Select.value);
                            const imgHeight = canvas.height * 0.85;
                            const img1Width = imgHeight * (playerImg1.width / playerImg1.height);
                            const img2Width = imgHeight * (playerImg2.width / playerImg2.height);
                            const imgY = canvas.height - imgHeight;
                            const img1X = 0;
                            const img2X = canvas.width - img2Width;
                            ctx.drawImage(playerImg1, img1X, imgY, img1Width, imgHeight);
                            ctx.drawImage(playerImg2, img2X, imgY, img2Width, imgHeight);
                            
                            const player1Name = player1Select.options[player1Select.selectedIndex].text;
                            const player2Name = player2Select.options[player2Select.selectedIndex].text;
                            
                            drawPlayerName(ctx, player1Name, img1X, imgY, img1Width, imgHeight);
                            drawPlayerName(ctx, player2Name, img2X, imgY, img2Width, imgHeight);
                        }

                        const fullMatchFontSize = Math.floor(canvas.height * 0.06);
                        ctx.font = `bold ${fullMatchFontSize}px "Inter"`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'top';
                        ctx.shadowColor = 'rgba(0,0,0,0.5)';
                        ctx.shadowBlur = 8;
                        ctx.fillText("FULL MATCH", canvas.width * 0.02, canvas.height * 0.02);
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;


                    } else if (uploadedLogo) {
                         const paddingPercent = 0.595;
                         const maxLogoDim = Math.min(canvas.width, canvas.height) * paddingPercent;
                         const logoAR = uploadedLogo.width / uploadedLogo.height;
                         let logoWidth, logoHeight;
                         if (logoAR > 1) { logoWidth = maxLogoDim; logoHeight = logoWidth / logoAR; } else { logoHeight = maxLogoDim; logoWidth = logoHeight * logoAR; }
                         const logoY = ((canvas.height - logoHeight) / 2) - (canvas.height * 0.1);
                         ctx.drawImage(uploadedLogo, (canvas.width - logoWidth) / 2, logoY, logoWidth, logoHeight);
                    }
                    
                    if (customText) {
                        let fontSize = Math.floor(canvas.height * 0.18);
                        ctx.font = `700 ${fontSize}px "Chakra Petch"`;
                        const maxWidth = canvas.width * 0.9;
                        while (ctx.measureText(customText).width > maxWidth && fontSize > 10) { fontSize--; ctx.font = `700 ${fontSize}px "Chakra Petch"`; }
                        ctx.fillStyle = '#FFFFFF';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = 'rgba(0,0,0,0.5)';
                        ctx.shadowBlur = 10;
                        ctx.fillText(customText, canvas.width / 2, canvas.height * (usePlayers ? 0.35 : 0.85));
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                    }

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    createImageCard(dataUrl, `${size.width} x ${size.height}`);
                }
                
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Image';
            }
            
             function drawPlayerName(ctx, fullName, imgX, imgY, imgWidth, imgHeight) {
                const nameParts = fullName.split(' ');
                const lastName = nameParts.pop().toUpperCase();
                const firstName = nameParts.join(' ');
                const lastNameSize = (imgHeight * 0.15) * 0.7;
                const firstNameSize = (imgHeight * 0.1) * 0.7;
                ctx.font = `800 ${lastNameSize}px Poppins`;
                const lastNameMetrics = ctx.measureText(lastName);
                ctx.font = `italic 300 ${firstNameSize}px Farsan`;
                const firstNameMetrics = ctx.measureText(firstName);
                const boxPadding = lastNameSize * 0.2;
                const boxWidth = Math.max(lastNameMetrics.width, firstNameMetrics.width) + (boxPadding * 2);
                const boxHeight = lastNameSize + firstNameSize + (boxPadding * 2);
                const boxX = imgX + (imgWidth - boxWidth) / 2;
                const boxY = imgY + imgHeight - boxHeight;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
                ctx.fillStyle = '#000000';
                ctx.font = `italic 300 ${firstNameSize}px Farsan`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(firstName, boxX + boxPadding, boxY + boxPadding + firstNameSize / 2);
                ctx.fillStyle = '#06402b';
                ctx.font = `800 ${lastNameSize}px Poppins`;
                ctx.fillText(lastName, boxX + boxPadding, boxY + boxPadding + firstNameSize + lastNameSize / 2);
            }

            function drawDoublesNames(ctx, name1, name2, alignment) {
                const canvas = ctx.canvas;
                const imgHeight = canvas.height * 0.85; 
                const lastName1 = name1.split(' ').pop().toUpperCase() + ' /'; // Top name
                const lastName2 = name2.split(' ').pop().toUpperCase(); // Bottom name

                const lastName2Size = (imgHeight * 0.15) * 0.7; 
                const lastName1Size = (imgHeight * 0.1) * 0.7;

                ctx.font = `300 ${lastName1Size}px Inter`;
                const lastName1Metrics = ctx.measureText(lastName1);
                ctx.font = `800 ${lastName2Size}px Inter`;
                const lastName2Metrics = ctx.measureText(lastName2);

                const boxPadding = lastName2Size * 0.2;
                const boxWidth = Math.max(lastName1Metrics.width, lastName2Metrics.width) + (boxPadding * 2);
                const boxHeight = lastName1Size + lastName2Size + (boxPadding * 2);
                
                const paddingFromEdge = canvas.width * 0.02;
                const boxYPos = canvas.height - boxHeight - paddingFromEdge;
                
                let boxXPos;
                if (alignment === 'left') {
                    boxXPos = paddingFromEdge;
                } else { // right
                    boxXPos = canvas.width - boxWidth - paddingFromEdge;
                }

                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(boxXPos, boxYPos, boxWidth, boxHeight);

                ctx.fillStyle = '#000000';
                ctx.font = `300 ${lastName1Size}px Inter`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(lastName1, boxXPos + boxPadding, boxYPos + boxPadding + lastName1Size / 2);

                ctx.fillStyle = '#06402b';
                ctx.font = `800 ${lastName2Size}px Inter`;
                ctx.fillText(lastName2, boxXPos + boxPadding, boxYPos + boxPadding + lastName1Size + lastName2Size / 2);
            }

            function loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                    img.src = src.startsWith('http') ? `${CORS_PROXY_URL}${src}` : src;
                });
            }

            function createImageCard(dataUrl, dimensionText) {
                imageGrid.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'bg-slate-50 p-3 rounded-lg shadow-sm border flex flex-col items-center';
                const img = document.createElement('img');
                img.src = dataUrl;
                img.className = 'w-full h-auto rounded-md object-contain mb-3 bg-white';
                img.style.aspectRatio = '16/9';
                
                const downloadLink = document.createElement('a');
                downloadLink.href = dataUrl;
                downloadLink.download = `generated-image-${dimensionText.replace(' x ', 'x')}.jpg`;
                downloadLink.textContent = `Download JPG (${dimensionText})`;
                downloadLink.className = 'mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium';
                
                card.appendChild(img);
                card.appendChild(downloadLink);
                imageGrid.appendChild(card);
            }

            function syncColorInputs(picker, hex) {
                 picker.addEventListener('input', (e) => hex.value = e.target.value);
                 hex.addEventListener('input', (e) => {
                     if (/^#[0-9A-F]{6}$/i.test(e.target.value)) { picker.value = e.target.value; }
                 });
            }
            syncColorInputs(colorPicker1, hexInput1);
            syncColorInputs(colorPicker2, hexInput2);

            function setupSwatches(swatchGroup, picker, hex) {
                swatchGroup.forEach(swatch => {
                    swatch.addEventListener('click', () => {
                        const color = swatch.dataset.color;
                        picker.value = color;
                        hex.value = color;
                    });
                });
            }
            setupSwatches(swatches1, colorPicker1, hexInput1);
            setupSwatches(swatches2, colorPicker2, hexInput2);

            // --- Initial Setup ---
            updateBackgroundControls();
            updateGenerateButtonState();
        });
    </script>
</body>
</html>

